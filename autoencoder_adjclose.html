<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>autoencoder_adjclose</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="autoencoder_adjclose_files/libs/clipboard/clipboard.min.js"></script>
<script src="autoencoder_adjclose_files/libs/quarto-html/quarto.js"></script>
<script src="autoencoder_adjclose_files/libs/quarto-html/popper.min.js"></script>
<script src="autoencoder_adjclose_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="autoencoder_adjclose_files/libs/quarto-html/anchor.min.js"></script>
<link href="autoencoder_adjclose_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="autoencoder_adjclose_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="autoencoder_adjclose_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="autoencoder_adjclose_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="autoencoder_adjclose_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">



<p>This google colab jupyter notebook simulates normalized 60 minute stock prices by sampling from the joint distribution of small encoded representations obtained by an autoencoder. The dependence structure of the joint distribution is estimated with a Gaussian copula. The autoencoder uses mostly 1d convolutional layers. After obtaining the new sample of small representations, these are fed into the decoder part of the autoencoder to yield unnormalized simulated stock prices. The data on stock prices comes from twelvedata.com and contains minutely stock prices of 133 stocks in the sp500 from June 2020 to January 2023. The minutely volume data of these stocks is also used.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install scikit<span class="op">-</span>fda</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> multivariate_normal</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> skfda</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> skfda.misc.hat_matrix <span class="im">import</span> (</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    KNeighborsHatMatrix,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    LocalLinearRegressionHatMatrix,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    NadarayaWatsonHatMatrix,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> skfda.misc.kernels <span class="im">import</span> uniform</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> skfda.preprocessing.smoothing <span class="im">import</span> KernelSmoother</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> skfda.preprocessing.smoothing.validation <span class="im">import</span> SmoothingParameterSearch</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> skfda <span class="im">import</span> FDataGrid</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="107ba016-fc05-47f2-db7a-abe9e29a9dc2" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>drive.mount(<span class="st">'/content/drive/'</span>, force_remount<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pwd</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> restore_df(path):</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(path)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.set_index(df[<span class="st">'Unnamed: 0'</span>])</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    df.drop(<span class="st">'Unnamed: 0'</span>, axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_obj(obj, name ):</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>     <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'drive/MyDrive/tradingbot/obj/'</span><span class="op">+</span> name <span class="op">+</span> <span class="st">'.pkl'</span>, <span class="st">'wb'</span>) <span class="im">as</span> f:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>         pickle.dump(obj, f, pickle.HIGHEST_PROTOCOL)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_obj(name ):</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'drive/MyDrive/tradingbot/obj/'</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">'.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pickle.load(f)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>tic_ind <span class="op">=</span> load_obj(<span class="st">'tics_indices'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mounted at /content/drive/
/content</code></pre>
</div>
</div>
<div class="cell" data-outputid="a222b856-9984-4393-b1c5-ade0b2f56666" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load adjusted close and volume</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>dfac <span class="op">=</span> restore_df(<span class="st">'drive/MyDrive/tradingbot/complete_230120/adj_complete.csv'</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>dfv <span class="op">=</span> restore_df(<span class="st">'drive/MyDrive/tradingbot/complete_230120/vol_complete.csv'</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># use everythign except val indices as training</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>val_indices <span class="op">=</span> <span class="bu">range</span>(<span class="dv">35000</span>, <span class="dv">65000</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>tic_ind_tr <span class="op">=</span> []</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>tic_ind_val <span class="op">=</span> []</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(tic_ind)):</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> tic_ind[i][<span class="dv">1</span>] <span class="kw">not</span> <span class="kw">in</span> val_indices:</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    tic_ind_tr.append(tic_ind[i])</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">continue</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> tic_ind[i][<span class="dv">1</span>] <span class="kw">in</span> val_indices:</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    tic_ind_val.append(tic_ind[i])</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(tic_ind_tr)) <span class="co"># how many rows in training set</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tic_ind_tr[<span class="dv">1</span>])</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(tic_ind_val)) <span class="co"># how many rows in validation set</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tic_ind_val[<span class="dv">1</span>])</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># tic_ind_tr give the tickers and indices of the training set. one observation will be 60 minutes </span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># of (normalized) adjusted returns and volumes for a ticker.</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># the 60 minutes will be from index-60:index.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>433671
('MRNA', 83763)
66329
('SBUX', 46917)</code></pre>
</div>
</div>
<div class="cell" data-outputid="417384d7-603a-404f-d79e-b3b583cdaa65" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dfac.head(<span class="op">-</span><span class="dv">5</span>) <span class="co"># prices of 133 stocks taken each minute (some adjusted closing price) from 2020-06-01 </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to 2023-01-20.</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># dfv is the volume taken each minute for the same stocks and same timeframe.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># data taken from twelvedata.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">


  <div id="df-b9cf262c-4de5-49af-b18b-ce401225a835" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>META</th>
      <th>TSM</th>
      <th>TSLA</th>
      <th>V</th>
      <th>JPM</th>
      <th>NVDA</th>
      <th>JNJ</th>
      <th>WMT</th>
      <th>...</th>
      <th>COST</th>
      <th>C</th>
      <th>UL</th>
      <th>AZN</th>
      <th>BUD</th>
      <th>PDD</th>
      <th>GS</th>
      <th>AMT</th>
      <th>CAT</th>
      <th>MMM</th>
    </tr>
    <tr>
      <th>Unnamed: 0</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-01 09:30:00</th>
      <td>79.387500</td>
      <td>2449.662475</td>
      <td>223.939998</td>
      <td>50.654000</td>
      <td>172.170750</td>
      <td>194.470000</td>
      <td>97.662500</td>
      <td>352.050005</td>
      <td>147.734998</td>
      <td>123.756450</td>
      <td>...</td>
      <td>308.092925</td>
      <td>47.900400</td>
      <td>54.22500</td>
      <td>54.393750</td>
      <td>47.76490</td>
      <td>66.30250</td>
      <td>196.521253</td>
      <td>257.383793</td>
      <td>119.216250</td>
      <td>155.917498</td>
    </tr>
    <tr>
      <th>2020-06-01 09:31:00</th>
      <td>79.537915</td>
      <td>2454.709960</td>
      <td>225.270000</td>
      <td>50.737500</td>
      <td>173.060500</td>
      <td>194.899998</td>
      <td>97.792100</td>
      <td>352.906507</td>
      <td>147.798747</td>
      <td>123.915500</td>
      <td>...</td>
      <td>308.525010</td>
      <td>48.062500</td>
      <td>54.28625</td>
      <td>54.430800</td>
      <td>47.80500</td>
      <td>66.96500</td>
      <td>196.627500</td>
      <td>257.718760</td>
      <td>118.734950</td>
      <td>156.009923</td>
    </tr>
    <tr>
      <th>2020-06-01 09:32:00</th>
      <td>79.667500</td>
      <td>2456.404968</td>
      <td>225.000000</td>
      <td>50.757500</td>
      <td>173.086650</td>
      <td>194.907500</td>
      <td>97.781950</td>
      <td>352.707493</td>
      <td>147.987050</td>
      <td>123.961650</td>
      <td>...</td>
      <td>308.759997</td>
      <td>48.127500</td>
      <td>54.28250</td>
      <td>54.387500</td>
      <td>47.75540</td>
      <td>67.20750</td>
      <td>196.720000</td>
      <td>257.867500</td>
      <td>118.258900</td>
      <td>155.732497</td>
    </tr>
    <tr>
      <th>2020-06-01 09:33:00</th>
      <td>79.556235</td>
      <td>2457.949950</td>
      <td>225.152500</td>
      <td>50.677500</td>
      <td>172.674000</td>
      <td>194.400000</td>
      <td>97.627000</td>
      <td>349.940000</td>
      <td>148.063970</td>
      <td>123.562300</td>
      <td>...</td>
      <td>308.254993</td>
      <td>48.018750</td>
      <td>54.23750</td>
      <td>54.272500</td>
      <td>47.67250</td>
      <td>66.92000</td>
      <td>196.674993</td>
      <td>256.999910</td>
      <td>118.140000</td>
      <td>155.584997</td>
    </tr>
    <tr>
      <th>2020-06-01 09:34:00</th>
      <td>79.485675</td>
      <td>2456.260010</td>
      <td>225.515855</td>
      <td>50.651250</td>
      <td>172.661025</td>
      <td>194.075775</td>
      <td>97.714925</td>
      <td>349.657492</td>
      <td>148.070000</td>
      <td>123.460000</td>
      <td>...</td>
      <td>307.835005</td>
      <td>47.981250</td>
      <td>54.17500</td>
      <td>54.207500</td>
      <td>47.60750</td>
      <td>66.56625</td>
      <td>196.610007</td>
      <td>256.245010</td>
      <td>118.221250</td>
      <td>155.370230</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-01-20 15:50:00</th>
      <td>137.500002</td>
      <td>97.167450</td>
      <td>139.425005</td>
      <td>90.771250</td>
      <td>133.180003</td>
      <td>223.737500</td>
      <td>134.987492</td>
      <td>178.017500</td>
      <td>168.277000</td>
      <td>140.435002</td>
      <td>...</td>
      <td>479.512502</td>
      <td>50.931200</td>
      <td>50.95125</td>
      <td>69.116250</td>
      <td>59.71875</td>
      <td>92.95500</td>
      <td>343.025000</td>
      <td>220.451250</td>
      <td>249.268753</td>
      <td>120.171250</td>
    </tr>
    <tr>
      <th>2023-01-20 15:51:00</th>
      <td>137.566683</td>
      <td>97.163750</td>
      <td>139.399972</td>
      <td>90.782500</td>
      <td>133.180625</td>
      <td>223.891240</td>
      <td>135.009997</td>
      <td>178.080798</td>
      <td>168.279998</td>
      <td>140.537508</td>
      <td>...</td>
      <td>479.855000</td>
      <td>50.953750</td>
      <td>50.96650</td>
      <td>69.101250</td>
      <td>59.70750</td>
      <td>92.96250</td>
      <td>342.840003</td>
      <td>220.666253</td>
      <td>249.435005</td>
      <td>120.223750</td>
    </tr>
    <tr>
      <th>2023-01-20 15:52:00</th>
      <td>137.705008</td>
      <td>97.251250</td>
      <td>139.441250</td>
      <td>90.811250</td>
      <td>133.329950</td>
      <td>224.050005</td>
      <td>135.072500</td>
      <td>178.284998</td>
      <td>168.305005</td>
      <td>140.572833</td>
      <td>...</td>
      <td>480.177498</td>
      <td>50.985625</td>
      <td>50.97625</td>
      <td>69.125000</td>
      <td>59.70500</td>
      <td>92.99000</td>
      <td>343.027503</td>
      <td>220.902500</td>
      <td>249.577497</td>
      <td>120.312500</td>
    </tr>
    <tr>
      <th>2023-01-20 15:53:00</th>
      <td>137.720003</td>
      <td>97.215000</td>
      <td>139.480032</td>
      <td>90.777500</td>
      <td>133.275350</td>
      <td>224.140020</td>
      <td>135.046250</td>
      <td>178.187500</td>
      <td>168.288723</td>
      <td>140.632555</td>
      <td>...</td>
      <td>480.126075</td>
      <td>51.016500</td>
      <td>50.97625</td>
      <td>69.083750</td>
      <td>59.70375</td>
      <td>92.95500</td>
      <td>342.988753</td>
      <td>220.891875</td>
      <td>249.589998</td>
      <td>120.357500</td>
    </tr>
    <tr>
      <th>2023-01-20 15:54:00</th>
      <td>137.584997</td>
      <td>97.197500</td>
      <td>139.429995</td>
      <td>90.730475</td>
      <td>133.332450</td>
      <td>224.143743</td>
      <td>135.028747</td>
      <td>178.100000</td>
      <td>168.256248</td>
      <td>140.685000</td>
      <td>...</td>
      <td>479.767500</td>
      <td>51.022500</td>
      <td>50.98125</td>
      <td>69.128125</td>
      <td>59.72750</td>
      <td>92.91625</td>
      <td>342.712550</td>
      <td>220.904995</td>
      <td>249.614997</td>
      <td>120.425000</td>
    </tr>
  </tbody>
</table>
<p>258947 rows × 134 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-b9cf262c-4de5-49af-b18b-ce401225a835')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-b9cf262c-4de5-49af-b18b-ce401225a835 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-b9cf262c-4de5-49af-b18b-ce401225a835');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-1f76d14c-63a2-49b5-be51-d062f30a3786">
  <button class="colab-df-quickchart" onclick="quickchart('df-1f76d14c-63a2-49b5-be51-d062f30a3786')" title="Suggest charts." style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-1f76d14c-63a2-49b5-be51-d062f30a3786 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>
</div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tables <span class="im">import</span> Array</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># mean function which gives one if mean is zero (because volume can have mean of zero, if stock was </span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># not traded over 60 minutes. in that case normalization can't divide by zero.)</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mean(array):</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  mean <span class="op">=</span> np.mean(array)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> mean <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mean</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ksmooth(array, bw<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  smo <span class="op">=</span> FDataGrid(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    grid_points<span class="op">=</span><span class="bu">range</span>(<span class="dv">60</span>),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    data_matrix<span class="op">=</span>array,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  smo1 <span class="op">=</span> KernelSmoother(</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>      kernel_estimator<span class="op">=</span>NadarayaWatsonHatMatrix(bandwidth<span class="op">=</span>bw),</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  ).fit_transform(smo)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> smo1.data_matrix.reshape(<span class="dv">1</span>,<span class="dv">60</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co"># get a list with the (training and validation) observations. normalize the adjusted closing prices </span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># by subtracting the (60 minute) mean and dividing by the 60 minute mean.</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co"># I don't divide by the standard deviation, because this would result in a standard deviation of 1 </span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co"># for all observations, which would lose too much information for the autoencoder.</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co"># the volume data is smoothed with a nadaraya watson kernel with bandwith 2 minutes.</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>tr <span class="op">=</span> []</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tic_ind <span class="kw">in</span> tic_ind_tr:</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  ac <span class="op">=</span> (dfac[tic_ind[<span class="dv">0</span>]][(tic_ind[<span class="dv">1</span>]<span class="op">-</span><span class="dv">60</span>):tic_ind[<span class="dv">1</span>]]).to_numpy()</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  ac <span class="op">=</span> (ac<span class="op">-</span>np.mean(ac))<span class="op">/</span>np.mean(ac)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  vol <span class="op">=</span> (dfv[tic_ind[<span class="dv">0</span>]][(tic_ind[<span class="dv">1</span>]<span class="op">-</span><span class="dv">60</span>):tic_ind[<span class="dv">1</span>]]).to_numpy()</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  vol <span class="op">=</span> (vol<span class="op">-</span>np.mean(vol))<span class="op">/</span>mean(vol)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  tr.append(np.vstack((ac, ksmooth(vol))))</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>val <span class="op">=</span> []</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tic_ind <span class="kw">in</span> tic_ind_val:</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>  ac <span class="op">=</span> (dfac[tic_ind[<span class="dv">0</span>]][(tic_ind[<span class="dv">1</span>]<span class="op">-</span><span class="dv">60</span>):tic_ind[<span class="dv">1</span>]]).to_numpy()</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  ac <span class="op">=</span> (ac<span class="op">-</span>np.mean(ac))<span class="op">/</span>np.mean(ac)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  vol <span class="op">=</span> (dfv[tic_ind[<span class="dv">0</span>]][(tic_ind[<span class="dv">1</span>]<span class="op">-</span><span class="dv">60</span>):tic_ind[<span class="dv">1</span>]]).to_numpy()</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  vol <span class="op">=</span> (vol<span class="op">-</span>np.mean(vol))<span class="op">/</span>mean(vol)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>  val.append(np.vstack((ac, ksmooth(vol))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make the dataset object for the autoencoder</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> acvol_data(Dataset):</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, train_or_val):</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    xy <span class="op">=</span> np.array(train_or_val)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.features <span class="op">=</span> torch.from_numpy(xy)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.targets <span class="op">=</span> torch.from_numpy(xy[:,<span class="dv">0</span>,:])</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.n_samples <span class="op">=</span> xy.shape[<span class="dv">0</span>]</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>,index):</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.features[index], <span class="va">self</span>.targets[index]</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.n_samples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Reshape(nn.Module):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="op">*</span>args):</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.shape<span class="op">=</span>args</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.reshape(x, <span class="va">self</span>.shape)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># this autoencoder uses 1d convolutional layers. 2 input channels are: 60 minute normalized prices </span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># and 60 minute smoothed volume. encoded prices are of lenght 5.</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># output of the model should be the original 50 minute normalized prices</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AutoEncoder(nn.Module):</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.encoder <span class="op">=</span> nn.Sequential(</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>      nn.Conv1d(in_channels<span class="op">=</span><span class="dv">2</span>, out_channels<span class="op">=</span><span class="dv">10</span>, kernel_size <span class="op">=</span> <span class="dv">5</span>, stride<span class="op">=</span><span class="dv">1</span>, padding<span class="op">=</span><span class="dv">2</span>), <span class="co">#60</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>      nn.LeakyReLU(<span class="fl">0.01</span>),</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>      nn.Conv1d(in_channels<span class="op">=</span><span class="dv">10</span>, out_channels<span class="op">=</span><span class="dv">20</span>, kernel_size <span class="op">=</span> <span class="dv">5</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">0</span>), <span class="co">#28</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>      nn.LeakyReLU(<span class="fl">0.01</span>),</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>      nn.Conv1d(in_channels<span class="op">=</span><span class="dv">20</span>, out_channels<span class="op">=</span><span class="dv">20</span>, kernel_size <span class="op">=</span> <span class="dv">3</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">0</span>), <span class="co">#13</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>      nn.LeakyReLU(<span class="fl">0.01</span>),</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>      nn.Flatten(),</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>      nn.Linear(<span class="dv">260</span>, <span class="dv">5</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.decoder <span class="op">=</span> nn.Sequential(</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>      nn.Linear(<span class="dv">5</span>, <span class="dv">260</span>),</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>      Reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">20</span>, <span class="dv">13</span>),</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>      nn.ConvTranspose1d(in_channels<span class="op">=</span><span class="dv">20</span>, out_channels<span class="op">=</span><span class="dv">20</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, </span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>                         stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">0</span>, output_padding<span class="op">=</span><span class="dv">1</span>), <span class="co">#28</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>      nn.LeakyReLU(<span class="fl">0.01</span>),</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>      nn.ConvTranspose1d(in_channels<span class="op">=</span><span class="dv">20</span>, out_channels<span class="op">=</span><span class="dv">10</span>, kernel_size<span class="op">=</span><span class="dv">5</span>, </span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>                         stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">0</span>, output_padding<span class="op">=</span><span class="dv">1</span>), <span class="co">#60</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>      nn.LeakyReLU(<span class="fl">0.01</span>),</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>      nn.ConvTranspose1d(in_channels<span class="op">=</span><span class="dv">10</span>, out_channels<span class="op">=</span><span class="dv">1</span>, kernel_size<span class="op">=</span><span class="dv">5</span>, </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>                         stride<span class="op">=</span><span class="dv">1</span>, padding<span class="op">=</span><span class="dv">2</span>, output_padding<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>      nn.LeakyReLU(<span class="fl">0.01</span>),</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>      nn.Linear(<span class="dv">60</span>,<span class="dv">60</span>),</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>      Reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">60</span>)</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, x, encoding_decoding<span class="op">=</span><span class="st">"both"</span>):</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> encoding_decoding <span class="op">==</span> <span class="st">"both"</span>:</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>      x <span class="op">=</span> <span class="va">self</span>.encoder(x)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>      x <span class="op">=</span> <span class="va">self</span>.decoder(x)</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> x</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> encoding_decoding <span class="op">==</span> <span class="st">"encoding"</span>:</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>      x <span class="op">=</span> <span class="va">self</span>.encoder(x)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> x</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> encoding_decoding <span class="op">==</span> <span class="st">"decoding"</span>:</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>      x <span class="op">=</span> <span class="va">self</span>.decoder(x)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_autoencoder(num_epochs, model, optimizer, device, train_loader, val_loader, </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                      loss_fn<span class="op">=</span><span class="va">None</span>, logging_interval<span class="op">=</span><span class="dv">100</span>, skip_epoch_stats<span class="op">=</span><span class="va">False</span>, save_model<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> loss_fn <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    loss_fn <span class="op">=</span> F.mse_loss</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  start_time <span class="op">=</span> time.time()</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  epoch_losses_train <span class="op">=</span> []</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  epoch_losses_val <span class="op">=</span> []</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  min_val_loss <span class="op">=</span> <span class="bu">float</span>(<span class="st">"inf"</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(num_epochs):</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    model.train()</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    batch_losses_train <span class="op">=</span> []</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch_idx, (features, targets) <span class="kw">in</span> <span class="bu">enumerate</span>(train_loader):</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>      features <span class="op">=</span> features.to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>      targets <span class="op">=</span> targets.to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Forward and Backward Prop</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>      output <span class="op">=</span> model(features)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>      loss <span class="op">=</span> loss_fn(output, targets)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>      optimizer.zero_grad()</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>      loss.backward()</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Update model params</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>      optimizer.step()</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Logging</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>      batch_losses_train.append(loss.item())</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="kw">not</span> batch_idx <span class="op">%</span> logging_interval:</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Epoch: </span><span class="sc">%03d</span><span class="st">/</span><span class="sc">%03d</span><span class="st"> | Batch: </span><span class="sc">%04d</span><span class="st">/</span><span class="sc">%04d</span><span class="st"> | Loss: </span><span class="sc">%.5f</span><span class="st">'</span> <span class="op">%</span> (epoch<span class="op">+</span><span class="dv">1</span>, num_epochs, </span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>                                                                    batch_idx, <span class="bu">len</span>(train_loader),</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>                                                                    loss.item()<span class="op">*</span><span class="fl">1e6</span>))</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> skip_epoch_stats:</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>      model.<span class="bu">eval</span>()</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>      val_loss <span class="op">=</span> []</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">with</span> torch.no_grad():</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, (features, targets) <span class="kw">in</span> <span class="bu">enumerate</span>(val_loader):</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>          features <span class="op">=</span> features.to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>          targets <span class="op">=</span> targets.to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>          output <span class="op">=</span> model(features)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>          loss <span class="op">=</span> loss_fn(output, targets)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>          val_loss.append(loss.item())</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>      epoch_losses_train.append(np.mean(np.array(batch_losses_train)))</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>      epoch_losses_val.append(np.mean(np.array(val_loss)))</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">'Elapsed Time: </span><span class="sc">%.3f</span><span class="st">'</span> <span class="op">%</span> ((time.time()<span class="op">-</span>start_time)<span class="op">/</span><span class="dv">60</span>))</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">'Epoch: </span><span class="sc">%03d</span><span class="st">/</span><span class="sc">%03d</span><span class="st"> | Training Loss: </span><span class="sc">%.5f</span><span class="st"> | Val Loss: </span><span class="sc">%.5f</span><span class="st">'</span> <span class="op">%</span> (epoch<span class="op">+</span><span class="dv">1</span>, </span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>                                                                         num_epochs, </span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>                                                                         np.mean(np.array(batch_losses_train))<span class="op">*</span><span class="fl">1e6</span>, np.mean(np.array(val_loss))<span class="op">*</span><span class="fl">1e6</span>))</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> save_model <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> np.mean(np.array(val_loss)) <span class="op">&lt;</span> min_val_loss:</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>        min_val_loss <span class="op">=</span> np.mean(np.array(val_loss))</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>        torch.save(model.state_dict(), save_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="5a606c16-13c6-4867-e386-2a1236874c1a" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>cuda</code></pre>
</div>
</div>
<div class="cell" data-outputid="5f83519d-042b-4591-fb03-82a75a1aa76e" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># train the model</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>net <span class="op">=</span> AutoEncoder()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>tr_data <span class="op">=</span> acvol_data(tr)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>tr_dataloader <span class="op">=</span> DataLoader(dataset<span class="op">=</span>tr_data, batch_size<span class="op">=</span><span class="dv">16</span>, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>val_data <span class="op">=</span> acvol_data(val)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>val_dataloader <span class="op">=</span> DataLoader(dataset<span class="op">=</span>val_data, batch_size<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> optim.Adam(net.parameters(), lr<span class="op">=</span><span class="fl">1e-3</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>net.to(device)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>num_epochs <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>train_autoencoder(num_epochs<span class="op">=</span>num_epochs, model<span class="op">=</span>net, optimizer<span class="op">=</span>optimizer, device<span class="op">=</span>device, </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>                  train_loader<span class="op">=</span>tr_dataloader, val_loader<span class="op">=</span>val_dataloader, logging_interval<span class="op">=</span><span class="dv">10000</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>                  save_model <span class="op">=</span> <span class="st">'drive/MyDrive/tradingbot/autoencoder_adjclose/autoencoder_model.pth'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch: 001/005 | Batch: 0000/27105 | Loss: 13904.50634
Epoch: 001/005 | Batch: 10000/27105 | Loss: 0.61555
Epoch: 001/005 | Batch: 20000/27105 | Loss: 0.69676
Elapsed Time: 1.892
Epoch: 001/005 | Training Loss: 3.71437 | Val Loss: 0.67362
Epoch: 002/005 | Batch: 0000/27105 | Loss: 0.45652
Epoch: 002/005 | Batch: 10000/27105 | Loss: 0.74056
Epoch: 002/005 | Batch: 20000/27105 | Loss: 0.57274
Elapsed Time: 3.560
Epoch: 002/005 | Training Loss: 0.67671 | Val Loss: 0.71919
Epoch: 003/005 | Batch: 0000/27105 | Loss: 0.71966
Epoch: 003/005 | Batch: 10000/27105 | Loss: 0.58416
Epoch: 003/005 | Batch: 20000/27105 | Loss: 0.60526
Elapsed Time: 5.214
Epoch: 003/005 | Training Loss: 0.65256 | Val Loss: 0.61236
Epoch: 004/005 | Batch: 0000/27105 | Loss: 1.10388
Epoch: 004/005 | Batch: 10000/27105 | Loss: 0.42996
Epoch: 004/005 | Batch: 20000/27105 | Loss: 0.67961
Elapsed Time: 6.916
Epoch: 004/005 | Training Loss: 0.66328 | Val Loss: 0.64714
Epoch: 005/005 | Batch: 0000/27105 | Loss: 0.86522
Epoch: 005/005 | Batch: 10000/27105 | Loss: 0.42291
Epoch: 005/005 | Batch: 20000/27105 | Loss: 0.59647
Elapsed Time: 8.577
Epoch: 005/005 | Training Loss: 0.64251 | Val Loss: 0.58371</code></pre>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the encoding of all validation observations</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> batch_idx, (features, targets) <span class="kw">in</span> <span class="bu">enumerate</span>(val_dataloader):</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  features <span class="op">=</span> features.to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> batch_idx <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    val_encoding <span class="op">=</span> net(features, encoding_decoding<span class="op">=</span><span class="st">"encoding"</span>).detach().cpu().numpy()</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    val_encoding <span class="op">=</span> np.vstack((val_encoding, </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                              net(features, </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                                  encoding_decoding<span class="op">=</span><span class="st">"encoding"</span>).detach().cpu().numpy()))</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>tics_val <span class="op">=</span> []</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>inds_val <span class="op">=</span> []</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(tic_ind_val)):</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  tics_val.append(tic_ind_val[i][<span class="dv">0</span>])</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  inds_val.append(tic_ind_val[i][<span class="dv">1</span>])</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>val_encoding_df <span class="op">=</span> pd.DataFrame(val_encoding, columns <span class="op">=</span> [<span class="st">'ae1'</span>,<span class="st">'ae2'</span>,<span class="st">'ae3'</span>,<span class="st">'ae4'</span>,<span class="st">'ae5'</span>])</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>val_encoding_df[<span class="st">'tics'</span>] <span class="op">=</span> tics_val</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>val_encoding_df[<span class="st">'inds'</span>] <span class="op">=</span> inds_val</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="96ebf4d7-3bc1-4d03-d084-c6f8b250f684" data-execution_count="17">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>val_encoding_df.head() <span class="co"># this is the encoding of the first 5 observations</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># in the validation set.</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#val_encoding_df.to_csv('drive/MyDrive/tradingbot/autoencoder_adjclose/val_encoding_3500065000.csv')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">


  <div id="df-5e52bb56-a18c-4f8d-ace7-91ea3db91ffc" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>ae1</th>
      <th>ae2</th>
      <th>ae3</th>
      <th>ae4</th>
      <th>ae5</th>
      <th>tics</th>
      <th>inds</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.115279</td>
      <td>-0.058429</td>
      <td>-0.038751</td>
      <td>0.050005</td>
      <td>0.140060</td>
      <td>ADI</td>
      <td>38866</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.121335</td>
      <td>-0.075760</td>
      <td>-0.030350</td>
      <td>0.064118</td>
      <td>0.189769</td>
      <td>SBUX</td>
      <td>46917</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.129521</td>
      <td>-0.067507</td>
      <td>-0.001304</td>
      <td>0.052397</td>
      <td>0.153418</td>
      <td>MMC</td>
      <td>54190</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.108646</td>
      <td>-0.102108</td>
      <td>-0.097563</td>
      <td>0.061516</td>
      <td>0.193405</td>
      <td>SE</td>
      <td>38412</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.144453</td>
      <td>-0.079140</td>
      <td>-0.030989</td>
      <td>0.045142</td>
      <td>0.130583</td>
      <td>DUK</td>
      <td>63290</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-5e52bb56-a18c-4f8d-ace7-91ea3db91ffc')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-5e52bb56-a18c-4f8d-ace7-91ea3db91ffc button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-5e52bb56-a18c-4f8d-ace7-91ea3db91ffc');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-a67dce14-390b-42ea-a455-9af5a8d650fd">
  <button class="colab-df-quickchart" onclick="quickchart('df-a67dce14-390b-42ea-a455-9af5a8d650fd')" title="Suggest charts." style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-a67dce14-390b-42ea-a455-9af5a8d650fd button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>
</div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the reconstruction of all observations in the validation dataset</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> batch_idx, (features, targets) <span class="kw">in</span> <span class="bu">enumerate</span>(val_dataloader):</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  features <span class="op">=</span> features.to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> batch_idx <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    val_reconstructed <span class="op">=</span> net(features).detach().cpu().numpy()</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    val_reconstructed <span class="op">=</span> np.vstack((val_reconstructed, net(features).detach().cpu().numpy()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>val_reconstructed_df <span class="op">=</span> pd.DataFrame(val_reconstructed, columns <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">61</span>))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>val_reconstructed_df[<span class="st">'tics'</span>] <span class="op">=</span> tics_val</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>val_reconstructed_df[<span class="st">'inds'</span>] <span class="op">=</span> inds_val</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the true observations in the validation set</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>val_true <span class="op">=</span> []</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tic_ind <span class="kw">in</span> tic_ind_val:</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  ac <span class="op">=</span> (dfac[tic_ind[<span class="dv">0</span>]][(tic_ind[<span class="dv">1</span>]<span class="op">-</span><span class="dv">60</span>):tic_ind[<span class="dv">1</span>]]).to_numpy()</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  ac <span class="op">=</span> (ac<span class="op">-</span>np.mean(ac))<span class="op">/</span>np.mean(ac)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  val_true.append(ac.tolist())</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>val_true_df <span class="op">=</span> pd.DataFrame(val_true)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to compare true stock prices vs reconstructed ones obtained from</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the autoencoder.</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_reconstruction(index, reconstructed_df, true_df):</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  plt.plot(<span class="bu">range</span>(<span class="dv">60</span>), reconstructed_df.iloc[index, <span class="dv">0</span>:<span class="dv">60</span>], label<span class="op">=</span><span class="st">"reconstructed"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  plt.plot(<span class="bu">range</span>(<span class="dv">60</span>), true_df.iloc[index,], label<span class="op">=</span><span class="st">"true"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  plt.legend()</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  plt.title(reconstructed_df.iloc[index, <span class="dv">60</span>])</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="db334626-0bcb-4ff2-a30a-37d7843ec034" data-execution_count="22">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>plot_reconstruction(<span class="dv">5000</span>, val_reconstructed_df, val_true_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="autoencoder_adjclose_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="a36940a6-b920-4c23-8bfe-214df53804a9" data-execution_count="23">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>plot_reconstruction(<span class="dv">1</span>, val_reconstructed_df, val_true_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="autoencoder_adjclose_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="13c9d60f-4075-430a-e59a-4f7769ba3bd7" data-execution_count="24">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>plot_reconstruction(<span class="dv">10000</span>, val_reconstructed_df, val_true_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="autoencoder_adjclose_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The reconstructed prices are usually smoother than the original ones. But not in terms of standard deviation</p>
<div class="cell" data-outputid="22466e12-37f6-495a-9207-52b31ca6d62e" data-execution_count="25">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># standard deviations of constructed vs true. for better visibility: log(sd)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>sds_reconstructed <span class="op">=</span> val_reconstructed_df.iloc[:,<span class="dv">0</span>:<span class="dv">60</span>].<span class="bu">apply</span>(np.std, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>sds_true <span class="op">=</span> val_true_df.<span class="bu">apply</span>(np.std, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>sds_df <span class="op">=</span> pd.concat([np.log(sds_reconstructed), np.log(sds_true)], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>sds_df.columns <span class="op">=</span> [<span class="st">"sds reconstructed"</span>, <span class="st">"sds true"</span>]</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>sds_df.plot(kind<span class="op">=</span><span class="st">"box"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="autoencoder_adjclose_files/figure-html/cell-22-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="23a9f998-c4a3-4984-bcec-30e01d9cdda3" data-execution_count="26">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to find out the joint distribution of encoding varibles, in order to simulate from them.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 vs 1 dependencies of the encoding variables. Marginally, the distributions seem to be normal ones.</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># For the 1 vs 1 dependencies a simple linear dependendy (correlation) seems to be enough.</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># =&gt; Make gaussian copula.</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>sns.pairplot(val_encoding_df.iloc[:,<span class="dv">0</span>:<span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>&lt;seaborn.axisgrid.PairGrid at 0x7dd6749a28c0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="autoencoder_adjclose_files/figure-html/cell-23-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="42485d34-7f74-4561-e6be-ad33387cbea1" data-execution_count="27">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For marginal distributions (assume gaussian marginals):</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>sds_encoding <span class="op">=</span> val_encoding_df.iloc[:, <span class="dv">0</span>:<span class="dv">5</span>].<span class="bu">apply</span>(np.std, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>means_encoding <span class="op">=</span> val_encoding_df.iloc[:, <span class="dv">0</span>:<span class="dv">5</span>].<span class="bu">apply</span>(np.mean, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sds_encoding)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(means_encoding)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ae1    0.046152
ae2    0.041025
ae3    0.058945
ae4    0.042450
ae5    0.079174
dtype: float32
ae1    0.125049
ae2   -0.058157
ae3   -0.032583
ae4    0.056762
ae5    0.170983
dtype: float32</code></pre>
</div>
</div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get probability integral transforms of marginals assuming they are guassian</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with parameters estimated one cell above.</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>encoding_pit_norm <span class="op">=</span> val_encoding_df.iloc[:,<span class="dv">0</span>:<span class="dv">5</span>].<span class="bu">apply</span>({<span class="st">"ae1"</span>: <span class="kw">lambda</span> x: norm.cdf(x, loc<span class="op">=</span>means_encoding[<span class="dv">0</span>], scale<span class="op">=</span>sds_encoding[<span class="dv">0</span>]),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                                                  <span class="st">"ae2"</span>: <span class="kw">lambda</span> x: norm.cdf(x, loc<span class="op">=</span>means_encoding[<span class="dv">1</span>], scale<span class="op">=</span>sds_encoding[<span class="dv">1</span>]),</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                                                  <span class="st">"ae3"</span>: <span class="kw">lambda</span> x: norm.cdf(x, loc<span class="op">=</span>means_encoding[<span class="dv">2</span>], scale<span class="op">=</span>sds_encoding[<span class="dv">2</span>]),</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                                                  <span class="st">"ae4"</span>: <span class="kw">lambda</span> x: norm.cdf(x, loc<span class="op">=</span>means_encoding[<span class="dv">3</span>], scale<span class="op">=</span>sds_encoding[<span class="dv">3</span>]),</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>                                                  <span class="st">"ae5"</span>: <span class="kw">lambda</span> x: norm.cdf(x, loc<span class="op">=</span>means_encoding[<span class="dv">4</span>], scale<span class="op">=</span>sds_encoding[<span class="dv">4</span>])})</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="338d7e66-cd52-4ce0-da97-3d57feddae36" data-execution_count="29">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>sns.pairplot(encoding_pit_norm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>&lt;seaborn.axisgrid.PairGrid at 0x7dd74df447c0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="autoencoder_adjclose_files/figure-html/cell-26-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The normal distributions are not good (we would expect the marginal distributions to be uniforms after applying the PIT of the true distributions). The original distributions have heavier tails. =&gt; use empirical distribution function.</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> ecdf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get ecdf PITs of all the marginal distributions</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ecdf2(ae):</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  ecdf1 <span class="op">=</span> ecdf(ae)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ecdf1.cdf.evaluate(ae)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>encoding_pit_ecdf <span class="op">=</span> val_encoding_df.iloc[:,<span class="dv">0</span>:<span class="dv">5</span>].<span class="bu">apply</span>(ecdf2, axis<span class="op">=</span><span class="dv">0</span>, result_type<span class="op">=</span><span class="st">"broadcast"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="0da07265-d5dd-4dc6-e8f3-4190e0658b02" data-execution_count="32">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now we have uniform marginals</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(encoding_pit_ecdf)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># from the uniform marginal distribution the sample correlation is an estimate</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># of the gaussian copula covariance matrix.</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>copula_cov <span class="op">=</span> encoding_pit_ecdf.corr()</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(copula_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            ae1       ae2       ae3       ae4       ae5
0      0.380723  0.494475  0.435375  0.408404  0.294969
1      0.454371  0.278747  0.518974  0.598260  0.635016
2      0.557675  0.371874  0.764718  0.439777  0.376412
3      0.307558  0.097936  0.090594  0.564625  0.657842
4      0.722565  0.244328  0.512762  0.348671  0.245805
...         ...       ...       ...       ...       ...
66324  0.914427  0.526497  0.736993  0.772076  0.193400
66325  0.651450  0.549639  0.800283  0.154111  0.424324
66326  0.077749  0.468558  0.789820  0.557554  0.049285
66327  0.784378  0.438360  0.345550  0.716941  0.739646
66328  0.952329  0.895913  0.204149  0.404634  0.520180

[66329 rows x 5 columns]
          ae1       ae2       ae3       ae4       ae5
ae1  1.000000 -0.384608 -0.075155 -0.129754  0.353925
ae2 -0.384608  1.000000 -0.043492  0.324364 -0.127297
ae3 -0.075155 -0.043492  1.000000 -0.289933 -0.333727
ae4 -0.129754  0.324364 -0.289933  1.000000 -0.077817
ae5  0.353925 -0.127297 -0.333727 -0.077817  1.000000</code></pre>
</div>
</div>
<div class="cell" data-outputid="6d5e8891-5963-464a-b3da-94647389d796" data-execution_count="68">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate from the gaussian copula with mean 0 and covariance matrix equal </span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to the sample correlation matrix of the ecdf matrix.</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>copula_sam <span class="op">=</span> multivariate_normal(mean <span class="op">=</span> [<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>], cov <span class="op">=</span> copula_cov).rvs(size<span class="op">=</span><span class="dv">25</span>)<span class="op">;</span> copula_sam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>array([[-0.26496579,  1.14688816,  0.00603058,  0.68691788, -0.05811048],
       [-1.08209286,  0.76438683,  0.27934716, -1.37535921,  0.38550835],
       [ 0.50725303, -0.6093681 , -1.81228562, -0.00405817,  2.07576636],
       [ 0.75445231, -1.40216256, -0.43249555,  0.17483044,  0.0517358 ],
       [-0.62397682, -0.86012547, -0.76407157, -0.85492052,  0.57269236],
       [ 0.4883166 ,  0.94170452, -1.5973281 , -0.03185015,  0.04057153],
       [-1.33333077, -1.58047456,  1.87938349, -2.81798412, -0.46789166],
       [-0.58990596,  0.77437525,  1.11247275,  0.62797047,  0.86435196],
       [ 1.40521188, -0.45450293,  0.64464101, -0.443105  , -0.30270636],
       [ 0.7923861 ,  1.48312046, -0.03938979, -0.56414649,  0.17487403],
       [-0.37663368,  1.31086477,  0.38845982, -0.43665321,  0.18999365],
       [ 1.32001458, -0.98556924,  0.87516483,  1.25413086,  0.19104674],
       [ 0.98632677, -0.84783637, -0.08161248, -1.13004453,  0.44972187],
       [ 0.73230214, -0.67441798,  0.31270288, -0.81889027,  0.50425903],
       [-0.34270057,  0.80231216, -0.82068577, -0.75939881,  0.3660083 ],
       [ 1.58998156, -1.7377321 ,  1.07462105,  0.34106603, -0.10701836],
       [ 0.23068969, -0.75441849, -0.89960162,  0.32172818,  0.50578287],
       [-0.89788024,  1.8255836 ,  0.28742602,  0.43157256, -0.00933585],
       [ 0.94519918,  0.33242634,  1.21500666, -1.38548967,  0.47909855],
       [-0.02049083, -1.12324154,  1.1524425 ,  0.2900453 , -1.0939577 ],
       [-0.57756663, -0.44560747, -0.54513077,  1.02823634,  1.16740425],
       [-0.58495213, -1.3898801 ,  0.1707381 , -0.16436391, -1.12198021],
       [ 2.1517965 ,  0.09176114, -1.87488571,  0.24124781,  0.77814315],
       [-2.35460256, -0.32519499, -1.25959051,  0.13973751, -0.5853302 ],
       [ 0.70530138, -0.04228179,  0.36711776,  0.46982182, -1.04809628]])</code></pre>
</div>
</div>
<div class="cell" data-outputid="ce005cab-2a1a-4dc0-ccdd-b2c5b331419d" data-execution_count="69">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in the gaussian copula each marginal distribution is a standard normal.</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># get pit of copula_sam by appling the standard normal cdf. </span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co"># now we have uniform marginals again.</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>pit_copula_sam <span class="op">=</span> np.apply_along_axis(norm.cdf, axis<span class="op">=</span><span class="dv">0</span>, arr<span class="op">=</span>copula_sam)<span class="op">;</span> pit_copula_sam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>array([[0.39551791, 0.87428608, 0.50240584, 0.75393276, 0.47683031],
       [0.13960564, 0.77768162, 0.61001079, 0.08451005, 0.65006959],
       [0.69401136, 0.27114024, 0.03497104, 0.49838103, 0.98104222],
       [0.77471116, 0.08043335, 0.33269064, 0.56939357, 0.52063039],
       [0.2663214 , 0.19485994, 0.2224123 , 0.19629758, 0.71657349],
       [0.6873372 , 0.82682803, 0.05509629, 0.48729578, 0.51618126],
       [0.09121164, 0.05699911, 0.96990393, 0.00241631, 0.31993103],
       [0.27762685, 0.78064554, 0.86703253, 0.73498836, 0.80630271],
       [0.92002086, 0.32473344, 0.74042007, 0.32884489, 0.38105683],
       [0.78593221, 0.9309788 , 0.48428981, 0.28632722, 0.56941069],
       [0.35322293, 0.90504827, 0.65116211, 0.33118143, 0.57534295],
       [0.90658493, 0.16217227, 0.80925789, 0.89510278, 0.57575551],
       [0.83801361, 0.19826455, 0.46747744, 0.12922873, 0.6735445 ],
       [0.76800791, 0.25002281, 0.6227468 , 0.20642451, 0.69296032],
       [0.36591187, 0.7888138 , 0.20591264, 0.22380701, 0.64282056],
       [0.94408052, 0.04112902, 0.85872779, 0.63347306, 0.45738721],
       [0.59122206, 0.22529899, 0.18416615, 0.62617069, 0.69349546],
       [0.1846247 , 0.9660435 , 0.61310693, 0.66697395, 0.49627559],
       [0.8277214 , 0.63021632, 0.88781822, 0.08295139, 0.68406574],
       [0.49182591, 0.13066746, 0.87543036, 0.61410921, 0.13698676],
       [0.28177837, 0.32794041, 0.29283179, 0.84808067, 0.87847642],
       [0.27928995, 0.08228265, 0.56778515, 0.43472233, 0.13093543],
       [0.98429331, 0.53655609, 0.03040422, 0.59531847, 0.78175769],
       [0.00927126, 0.37251675, 0.10390856, 0.5555663 , 0.27916286],
       [0.75968865, 0.48313703, 0.64323441, 0.68075884, 0.14729713]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to get inverse ecdfs.</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inverse_ecdf(sorted_ae, q):</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  l <span class="op">=</span> <span class="bu">len</span>(sorted_ae)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (sorted_ae[<span class="bu">int</span>(l<span class="op">*</span>q)])</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>pit_copula_sam_df <span class="op">=</span> pd.DataFrame(pit_copula_sam)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>pit_copula_sam_df.columns <span class="op">=</span> [<span class="st">"ae1"</span>, <span class="st">"ae2"</span>, <span class="st">"ae3"</span>, <span class="st">"ae4"</span>, <span class="st">"ae5"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="af7ffba1-bbfb-4dde-e95b-c1b90ae95d79" data-execution_count="71">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dataframe of the uniform marginal samples from before</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>pit_copula_sam_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">


  <div id="df-0b496d6c-830b-4a88-9058-d8837124108e" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>ae1</th>
      <th>ae2</th>
      <th>ae3</th>
      <th>ae4</th>
      <th>ae5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.395518</td>
      <td>0.874286</td>
      <td>0.502406</td>
      <td>0.753933</td>
      <td>0.476830</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.139606</td>
      <td>0.777682</td>
      <td>0.610011</td>
      <td>0.084510</td>
      <td>0.650070</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.694011</td>
      <td>0.271140</td>
      <td>0.034971</td>
      <td>0.498381</td>
      <td>0.981042</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.774711</td>
      <td>0.080433</td>
      <td>0.332691</td>
      <td>0.569394</td>
      <td>0.520630</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.266321</td>
      <td>0.194860</td>
      <td>0.222412</td>
      <td>0.196298</td>
      <td>0.716573</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.687337</td>
      <td>0.826828</td>
      <td>0.055096</td>
      <td>0.487296</td>
      <td>0.516181</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.091212</td>
      <td>0.056999</td>
      <td>0.969904</td>
      <td>0.002416</td>
      <td>0.319931</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.277627</td>
      <td>0.780646</td>
      <td>0.867033</td>
      <td>0.734988</td>
      <td>0.806303</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.920021</td>
      <td>0.324733</td>
      <td>0.740420</td>
      <td>0.328845</td>
      <td>0.381057</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.785932</td>
      <td>0.930979</td>
      <td>0.484290</td>
      <td>0.286327</td>
      <td>0.569411</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.353223</td>
      <td>0.905048</td>
      <td>0.651162</td>
      <td>0.331181</td>
      <td>0.575343</td>
    </tr>
    <tr>
      <th>11</th>
      <td>0.906585</td>
      <td>0.162172</td>
      <td>0.809258</td>
      <td>0.895103</td>
      <td>0.575756</td>
    </tr>
    <tr>
      <th>12</th>
      <td>0.838014</td>
      <td>0.198265</td>
      <td>0.467477</td>
      <td>0.129229</td>
      <td>0.673544</td>
    </tr>
    <tr>
      <th>13</th>
      <td>0.768008</td>
      <td>0.250023</td>
      <td>0.622747</td>
      <td>0.206425</td>
      <td>0.692960</td>
    </tr>
    <tr>
      <th>14</th>
      <td>0.365912</td>
      <td>0.788814</td>
      <td>0.205913</td>
      <td>0.223807</td>
      <td>0.642821</td>
    </tr>
    <tr>
      <th>15</th>
      <td>0.944081</td>
      <td>0.041129</td>
      <td>0.858728</td>
      <td>0.633473</td>
      <td>0.457387</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0.591222</td>
      <td>0.225299</td>
      <td>0.184166</td>
      <td>0.626171</td>
      <td>0.693495</td>
    </tr>
    <tr>
      <th>17</th>
      <td>0.184625</td>
      <td>0.966043</td>
      <td>0.613107</td>
      <td>0.666974</td>
      <td>0.496276</td>
    </tr>
    <tr>
      <th>18</th>
      <td>0.827721</td>
      <td>0.630216</td>
      <td>0.887818</td>
      <td>0.082951</td>
      <td>0.684066</td>
    </tr>
    <tr>
      <th>19</th>
      <td>0.491826</td>
      <td>0.130667</td>
      <td>0.875430</td>
      <td>0.614109</td>
      <td>0.136987</td>
    </tr>
    <tr>
      <th>20</th>
      <td>0.281778</td>
      <td>0.327940</td>
      <td>0.292832</td>
      <td>0.848081</td>
      <td>0.878476</td>
    </tr>
    <tr>
      <th>21</th>
      <td>0.279290</td>
      <td>0.082283</td>
      <td>0.567785</td>
      <td>0.434722</td>
      <td>0.130935</td>
    </tr>
    <tr>
      <th>22</th>
      <td>0.984293</td>
      <td>0.536556</td>
      <td>0.030404</td>
      <td>0.595318</td>
      <td>0.781758</td>
    </tr>
    <tr>
      <th>23</th>
      <td>0.009271</td>
      <td>0.372517</td>
      <td>0.103909</td>
      <td>0.555566</td>
      <td>0.279163</td>
    </tr>
    <tr>
      <th>24</th>
      <td>0.759689</td>
      <td>0.483137</td>
      <td>0.643234</td>
      <td>0.680759</td>
      <td>0.147297</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-0b496d6c-830b-4a88-9058-d8837124108e')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-0b496d6c-830b-4a88-9058-d8837124108e button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-0b496d6c-830b-4a88-9058-d8837124108e');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-cbbfb601-d20d-4989-98ac-53f5b7b45a2f">
  <button class="colab-df-quickchart" onclick="quickchart('df-cbbfb601-d20d-4989-98ac-53f5b7b45a2f')" title="Suggest charts." style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-cbbfb601-d20d-4989-98ac-53f5b7b45a2f button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>
</div>
</div>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># apply the inverse ecdf to the uniform marginals to get a sample of the</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co"># joint embedding distribution.</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>sam_aes <span class="op">=</span> pit_copula_sam_df.<span class="bu">apply</span>({<span class="st">"ae1"</span>: <span class="kw">lambda</span> x: inverse_ecdf(<span class="bu">sorted</span>(val_encoding_df[<span class="st">"ae1"</span>]), x),</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>                                                  <span class="st">"ae2"</span>: <span class="kw">lambda</span> x: inverse_ecdf(<span class="bu">sorted</span>(val_encoding_df[<span class="st">"ae2"</span>]), x),</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                                                  <span class="st">"ae3"</span>: <span class="kw">lambda</span> x: inverse_ecdf(<span class="bu">sorted</span>(val_encoding_df[<span class="st">"ae3"</span>]), x),</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                                                  <span class="st">"ae4"</span>: <span class="kw">lambda</span> x: inverse_ecdf(<span class="bu">sorted</span>(val_encoding_df[<span class="st">"ae4"</span>]), x),</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>                                                  <span class="st">"ae5"</span>: <span class="kw">lambda</span> x: inverse_ecdf(<span class="bu">sorted</span>(val_encoding_df[<span class="st">"ae5"</span>]), x)})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="7585c4d8-7421-4b52-d966-21b18da984d1" data-execution_count="73">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sampled embeddings</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>sam_aes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">


  <div id="df-65efb89f-4a6c-4852-b5c1-6b6722e2b697" class="colab-df-container">
    <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>ae1</th>
      <th>ae2</th>
      <th>ae3</th>
      <th>ae4</th>
      <th>ae5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.116559</td>
      <td>-0.020174</td>
      <td>-0.032006</td>
      <td>0.078112</td>
      <td>0.167646</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.086412</td>
      <td>-0.034480</td>
      <td>-0.020861</td>
      <td>0.007099</td>
      <td>0.192157</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.141552</td>
      <td>-0.076474</td>
      <td>-0.134208</td>
      <td>0.056698</td>
      <td>0.342334</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.150526</td>
      <td>-0.107162</td>
      <td>-0.050019</td>
      <td>0.061890</td>
      <td>0.173483</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.104410</td>
      <td>-0.084863</td>
      <td>-0.065359</td>
      <td>0.029556</td>
      <td>0.203490</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.140889</td>
      <td>-0.028133</td>
      <td>-0.115552</td>
      <td>0.055901</td>
      <td>0.172947</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.074210</td>
      <td>-0.115589</td>
      <td>0.073596</td>
      <td>-0.121722</td>
      <td>0.144367</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.105598</td>
      <td>-0.034106</td>
      <td>0.018703</td>
      <td>0.076115</td>
      <td>0.222309</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.179898</td>
      <td>-0.071504</td>
      <td>-0.004869</td>
      <td>0.043481</td>
      <td>0.154090</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.151993</td>
      <td>-0.005247</td>
      <td>-0.033835</td>
      <td>0.039544</td>
      <td>0.180381</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0.112871</td>
      <td>-0.013204</td>
      <td>-0.016197</td>
      <td>0.043661</td>
      <td>0.181216</td>
    </tr>
    <tr>
      <th>11</th>
      <td>0.175758</td>
      <td>-0.089590</td>
      <td>0.006199</td>
      <td>0.100393</td>
      <td>0.181273</td>
    </tr>
    <tr>
      <th>12</th>
      <td>0.160067</td>
      <td>-0.084447</td>
      <td>-0.035498</td>
      <td>0.018476</td>
      <td>0.195947</td>
    </tr>
    <tr>
      <th>13</th>
      <td>0.149759</td>
      <td>-0.078519</td>
      <td>-0.019452</td>
      <td>0.030821</td>
      <td>0.199317</td>
    </tr>
    <tr>
      <th>14</th>
      <td>0.114003</td>
      <td>-0.033159</td>
      <td>-0.067981</td>
      <td>0.033030</td>
      <td>0.191046</td>
    </tr>
    <tr>
      <th>15</th>
      <td>0.190188</td>
      <td>-0.124487</td>
      <td>0.016754</td>
      <td>0.066917</td>
      <td>0.165006</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0.132319</td>
      <td>-0.081223</td>
      <td>-0.072042</td>
      <td>0.066329</td>
      <td>0.199387</td>
    </tr>
    <tr>
      <th>17</th>
      <td>0.094182</td>
      <td>0.013343</td>
      <td>-0.020567</td>
      <td>0.069680</td>
      <td>0.170207</td>
    </tr>
    <tr>
      <th>18</th>
      <td>0.158316</td>
      <td>-0.048395</td>
      <td>0.024652</td>
      <td>0.006604</td>
      <td>0.197746</td>
    </tr>
    <tr>
      <th>19</th>
      <td>0.124313</td>
      <td>-0.095043</td>
      <td>0.021097</td>
      <td>0.065392</td>
      <td>0.101923</td>
    </tr>
    <tr>
      <th>20</th>
      <td>0.106024</td>
      <td>-0.071205</td>
      <td>-0.054938</td>
      <td>0.090907</td>
      <td>0.245006</td>
    </tr>
    <tr>
      <th>21</th>
      <td>0.105771</td>
      <td>-0.106475</td>
      <td>-0.025429</td>
      <td>0.052018</td>
      <td>0.099880</td>
    </tr>
    <tr>
      <th>22</th>
      <td>0.231387</td>
      <td>-0.055395</td>
      <td>-0.139894</td>
      <td>0.063865</td>
      <td>0.216707</td>
    </tr>
    <tr>
      <th>23</th>
      <td>-0.001554</td>
      <td>-0.067455</td>
      <td>-0.092651</td>
      <td>0.060863</td>
      <td>0.137143</td>
    </tr>
    <tr>
      <th>24</th>
      <td>0.148752</td>
      <td>-0.059204</td>
      <td>-0.017159</td>
      <td>0.070913</td>
      <td>0.105313</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-65efb89f-4a6c-4852-b5c1-6b6722e2b697')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-65efb89f-4a6c-4852-b5c1-6b6722e2b697 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-65efb89f-4a6c-4852-b5c1-6b6722e2b697');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-e889b857-61e8-48fb-8780-d98a0a506da9">
  <button class="colab-df-quickchart" onclick="quickchart('df-e889b857-61e8-48fb-8780-d98a0a506da9')" title="Suggest charts." style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-e889b857-61e8-48fb-8780-d98a0a506da9 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>
</div>
</div>
<div class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make the simulated sample to a dataset object to feed into the decoder</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> newsample_data(Dataset):</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, sam):</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    xy <span class="op">=</span> np.array(sam)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.features <span class="op">=</span> torch.from_numpy(xy)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.n_samples <span class="op">=</span> xy.shape[<span class="dv">0</span>]</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>,index):</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.features[index]</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.n_samples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>sam_data <span class="op">=</span> newsample_data(sam_aes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="41261c47-ed5d-4945-a460-0c93dc6ffffa" data-execution_count="76">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check if it worked</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(sam_data))</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>extract_batch_idx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> batch_idx, features <span class="kw">in</span> <span class="bu">enumerate</span>(sam_data):</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>      features <span class="op">=</span> features.to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> batch_idx <span class="op">==</span> extract_batch_idx:</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(features)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>25
tensor([ 0.1166, -0.0202, -0.0320,  0.0781,  0.1676], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-outputid="307a6274-6802-4df0-9c5c-37864e933999" data-execution_count="77">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make a dataloader from the dataset</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>sam_dataloader <span class="op">=</span> DataLoader(dataset<span class="op">=</span>sam_data)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>extract_batch_idx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> batch_idx, features <span class="kw">in</span> <span class="bu">enumerate</span>(sam_dataloader):</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>      features <span class="op">=</span> features.to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> batch_idx <span class="op">==</span> extract_batch_idx:</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(features)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor([[ 0.1166, -0.0202, -0.0320,  0.0781,  0.1676]], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># decode all the embeddings</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> batch_idx, features <span class="kw">in</span> <span class="bu">enumerate</span>(sam_dataloader):</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  features <span class="op">=</span> features.to(device, dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> batch_idx <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    decoded_sam <span class="op">=</span> net(features, encoding_decoding<span class="op">=</span><span class="st">"decoding"</span>).detach().cpu().numpy()</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    decoded_sam <span class="op">=</span> np.vstack((decoded_sam, net(features, encoding_decoding<span class="op">=</span><span class="st">"decoding"</span>).detach().cpu().numpy()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="46d90bdc-ce67-4ab9-cb78-4550a470d108" data-execution_count="79">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the new normalized stock prices</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_newsample(newsample):</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(newsample)):</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    plt.plot(<span class="bu">range</span>(<span class="dv">60</span>), newsample[i], label<span class="op">=</span><span class="ss">f"sam</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  plt.show()</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>plot_newsample(decoded_sam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="autoencoder_adjclose_files/figure-html/cell-41-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>On the borders, all simulated stock prices have the exact same slopes. I think this is due to the 1d convolutional layers used. Also, at minute 42 for example a large portion of simulated stock prices have a change in the sign of their slopes, from negative to positive (something similar happens at other times). This is probably due to the strong decoding (60 values to 5) and the limited training time (only 5 epochs).</p>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>